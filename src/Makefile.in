.SUFFIXES: .lo .re .c

OS=$(shell uname)

Q=
ifeq ($(V),)
	Q=@
endif

LIBCIRCLLHIST_VERSION=0.0.1

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
sbindir=@sbindir@
libdir=@libdir@
includedir=@includedir@
libexecdir=@libexecdir@
localstatedir=@localstatedir@
datarootdir=@datarootdir@
datadir=@datadir@
mandir=@mandir@
mansubdir=@mansubdir@
docdir=${prefix}/@docdir@
sysconfdir=@sysconfdir@
srcdir=@srcdir@
top_srcdir=@top_srcdir@

CC=@CC@
SHLD=@SHLD@
CPPFLAGS=@CPPFLAGS@
CFLAGS=@CFLAGS@
SHCFLAGS=@SHCFLAGS@
CLINKFLAGS=@CLINKFLAGS@
LUACFLAGS=@LUACFLAGS@
PGCFLAGS=@PGCFLAGS@
LDFLAGS=@LDFLAGS@ -L$(libdir)
RLDFLAG=@RLDFLAG@
ifneq ($(strip $(RLDFLAG)),)
  LDFLAGS += @RLDFLAG@$(libdir)
endif
SHLDFLAGS=@SHLDFLAGS@
DEPFLAGS=@DEPFLAGS@
MODULELD=@MODULELD@
AR=@AR@
RANLIB=@RANLIB@
LIBS=@LIBS@
INSTALL=@INSTALL@
MAPFLAGS=@MAPFLAGS@
CTFCONVERT=@CTFCONVERT@
CTFMERGE=@CTFMERGE@

# Later versions of ctf* tools no longer have -g and by default do not strip,
# so we get the same behavior as with -g on older versions.
ifneq ($(wildcard $(CTFCONVERT)),)
  HAS_G=$(shell $(CTFCONVERT) 2>&1 | grep -- -gis)
  ifneq ($(HAS_G),)
    CTFNOSTRIP=-g
  else
    CTFNOSTRIP=
  endif
endif

WHOLE_ARCHIVE=@WHOLE_ARCHIVE@
NOWHOLE_ARCHIVE=@NOWHOLE_ARCHIVE@
LIBCIRCLLHIST_V=libcircllhist@DOTSO@.$(LIBCIRCLLHIST_VERSION)@DOTDYLIB@
LIBCIRCLLHIST=libcircllhist@DOTSO@@DOTDYLIB@

ifeq ($(OS),Darwin)
SHLDFLAGS+=-current_version $(LIBCIRCLLHIST_VERSION) -install_name $(libdir)/$(LIBCIRCLLHIST_V)
endif

LUA_FFI=lua/ffi_libcircllhist.lua

TARGETS=$(LIBCIRCLLHIST) $(LUA_FFI) test/histogram_test test/histogram_perf

all:	reversion $(TARGETS)

HEADERS=circllhist.h

LIBCIRCLLHIST_OBJS=circllhist.lo

.PHONY:	reversion

reversion:
	@$(top_srcdir)/buildtools/mkversion.sh circllhist_version.h

circllhist_version.h:
	@$(top_srcdir)/buildtools/mkversion.sh circllhist_version.h

$(LIBCIRCLLHIST):	$(LIBCIRCLLHIST_V)
	ln -sf $(LIBCIRCLLHIST_V) $(LIBCIRCLLHIST)

$(LIBCIRCLLHIST_V):	$(LIBCIRCLLHIST_OBJS)
	@echo "- linking $@"
	$(SHLD) $(SHLDFLAGS) $(CFLAGS) -o $@ $(LIBCIRCLLHIST_OBJS) -lm

test/histogram_test: test/histogram_test.c $(LIBCIRCLLHIST)
	$(Q)$(CC) $(CPPFLAGS) $(CFLAGS) $(LDFLAGS) -I. -o $@ test/histogram_test.c -L. -L.. -lcircllhist

test/histogram_perf: test/histogram_perf.c $(LIBCIRCLLHIST)
	$(Q)$(CC) $(CPPFLAGS) $(CFLAGS) $(LDFLAGS) -I. -o $@ test/histogram_perf.c -L. -L.. -lcircllhist

$(LUA_FFI): 
	./generateLuaFiles.sh . $@

.c.lo:
		echo "- compiling $<" ; \
	  $(CC) $(CPPFLAGS) $(SHCFLAGS) -c $< -o $@ ; \

.c.o:
		echo "- compiling $<" ; \
		$(CC) $(CPPFLAGS) $(CFLAGS) -c $< ; \

install-headers:	$(HEADERS)
	$(top_srcdir)/buildtools/mkinstalldirs $(DESTDIR)$(includedir)
	for file in $(HEADERS) ; do \
		$(INSTALL) -m 0644 $$file $(DESTDIR)$(includedir)/$$file ; \
	done

install-libs:    $(LIBCIRCLLHIST) $(LUA_FFI)
	$(top_srcdir)/buildtools/mkinstalldirs $(DESTDIR)$(libdir)
	$(top_srcdir)/buildtools/mkinstalldirs $(DESTDIR)$(datadir)/lua/5.1
	$(INSTALL) -m 0755 $(LIBCIRCLLHIST_V) $(DESTDIR)$(libdir)/$(LIBCIRCLLHIST_V)
	ln -sf $(LIBCIRCLLHIST_V) $(DESTDIR)$(libdir)/$(LIBCIRCLLHIST)
	$(INSTALL) -m 0755 $(LUA_FFI) $(DESTDIR)$(datadir)/lua/5.1/

install:	install-headers install-libs

tests: test/histogram_test test/histogram_perf $(LUA_FFI)
	test/runTest.sh

clean:
	rm -f *.lo *.o $(TARGETS)
	rm -f $(LIBCIRCLLHIST)
	rm -f histogram_test
	rm -f histogram_perl
	rm -f $(LUA_FFI)

Makefile.dep:
	$(CC) -I. $(CPPFLAGS) $(CFLAGS) $(DEPFLAGS) *.c > Makefile.dep
	$(top_srcdir)/buildtools/culldeps.sh Makefile.dep

include Makefile.dep

distclean:	clean 

